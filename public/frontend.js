// Generated by CoffeeScript 1.7.1
(function() {
  var App,
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  App = (function() {
    App.prototype.canvas = null;

    App.prototype.stage = null;

    App.prototype.images = null;

    App.prototype.totalLoaded = 0;

    App.prototype.TitleView = null;

    App.prototype.socket = null;

    function App() {
      this.addGameView = __bind(this.addGameView, this);
      this.handleLoadComplete = __bind(this.handleLoadComplete, this);
      this.handleFileLoad = __bind(this.handleFileLoad, this);
      this.TitleView = new Container();
      this.Main();
      $(window).on('touchmove', function(e) {
        return e.preventDefault();
      });
    }

    App.prototype.Main = function() {
      var preloader;
      this.socket = io.connect("http://scott.local:3700");
      this.socket.on("connect", (function(_this) {
        return function() {
          _this.socket.emit("adduser", prompt("What's your name?"));
          return _this.socket.on("updateusers", function(data) {
            $.each(data, function(value) {
              $('#userDiv').html('');
              return $('#userDiv').append(value + ' has joined the game! <br/>');
            });
            return _this.socket.on("user_disconnect", function(value) {
              return $.each(data, function(value) {
                $('#disconnectDiv').html('');
                return $('#disconnectDiv').append(value + ' has disconnected...').delay(2000).fadeOut(2000);
              });
            });
          });
        };
      })(this));
      this.socket.on("user_num", (function(_this) {
        return function(user_num) {
          if (user_num < 2) {
            return _this.addTitleView;
          } else {
            return _this.tweenTitleView();
          }
        };
      })(this));
      this.socket.on("player_1_score", (function(_this) {
        return function() {
          return _this.playerOneScore();
        };
      })(this));
      this.socket.on("player_2_score", (function(_this) {
        return function() {
          return _this.playerTwoScore();
        };
      })(this));
      this.canvas = document.getElementById('PongStage');
      this.stage = new Stage(this.canvas);
      this.stage.canvas.width = $(window).width();
      this.stage.canvas.height = $(window).height();
      this.images = [
        {
          src: "images/waiting.gif",
          id: "wait"
        }, {
          src: "images/main.png",
          id: "main"
        }, {
          src: "images/bg.png",
          id: "bg"
        }, {
          src: "images/paddle.png",
          id: "player_1"
        }, {
          src: "images/paddle.png",
          id: "player_2"
        }, {
          src: "images/ball.png",
          id: "ball"
        }, {
          src: "images/player_1_win.png",
          id: "player_1_win"
        }, {
          src: "images/player_2_win.png",
          id: "player_2_win"
        }
      ];
      preloader = new PreloadJS();
      preloader.onFileLoad = this.handleFileLoad;
      preloader.loadManifest(this.images);
      Ticker.setFPS(25);
      return Ticker.addListener(this.stage);
    };

    App.prototype.handleFileLoad = function(e) {
      var img;
      switch (e.type) {
        case PreloadJS.IMAGE:
          img = new Image();
          img.src = e.src;
          img.onload = this.handleLoadComplete;
          window[e.id] = new Bitmap(img);
          return this.handleLoadComplete();
      }
    };

    App.prototype.handleLoadComplete = function() {
      this.totalLoaded++;
      if (this.images.length === this.totalLoaded) {
        return this.addTitleView();
      }
    };

    App.prototype.addTitleView = function() {
      wait.x = 100;
      wait.y = 180;
      Tween.get(wait).to({
        y: 130
      }, 500);
      this.TitleView.addChild(main, wait);
      return this.stage.addChild(bg, this.TitleView);
    };

    App.prototype.tweenTitleView = function() {
      return Tween.get(this.TitleView).to({
        y: -320
      }, 500).call(this.addGameView);
    };

    App.prototype.addGameView = function() {
      $('#userDiv').delay(500).fadeOut(1500);
      this.stage.removeChild(this.TitleView);
      this.TitleView = null;
      player_1.x = 2;
      player_1.y = 160 - 37.5;
      player_2.x = 480 - 25;
      player_2.y = 160 - 37.5;
      ball.x = 240 - 15;
      ball.y = 160 - 15;
      this.player_1_score = new Text('0', 'bold 20px Arial', '#A3FF24');
      this.player_1_score.x = 211;
      this.player_1_score.y = 20;
      this.player_2_score = new Text('0', 'bold 20px Arial', '#A3FF24');
      this.player_2_score.x = 262;
      this.player_2_score.y = 20;
      document.addEventListener('touchstart', (function(_this) {
        return function(touch) {
          var _i, _len, _ref, _results;
          _ref = touch.touches;
          _results = [];
          for (_i = 0, _len = _ref.length; _i < _len; _i++) {
            touch = _ref[_i];
            if (touch.pageX < $('#PongStage').width() / 2) {
              _this.socket.emit("move_1", touch.pageY);
            }
            if (touch.pageX > $('#PongStage').width() / 2) {
              _results.push(_this.socket.emit("move_2", touch.pageY));
            } else {
              _results.push(void 0);
            }
          }
          return _results;
        };
      })(this));
      document.addEventListener('touchmove', (function(_this) {
        return function(touch) {
          var _i, _len, _ref, _results;
          _ref = touch.touches;
          _results = [];
          for (_i = 0, _len = _ref.length; _i < _len; _i++) {
            touch = _ref[_i];
            if (touch.pageX < $('#PongStage').width() / 2) {
              _this.socket.emit("move_1", touch.pageY);
            }
            if (touch.pageX > $('#PongStage').width() / 2) {
              _results.push(_this.socket.emit("move_2", touch.pageY));
            } else {
              _results.push(void 0);
            }
          }
          return _results;
        };
      })(this));
      this.socket.on("paddle_1", (function(_this) {
        return function(pageY) {
          return _this.movePaddle_1(pageY);
        };
      })(this));
      this.socket.on("paddle_2", (function(_this) {
        return function(pageY) {
          return _this.movePaddle_2(pageY);
        };
      })(this));
      this.stage.addChild(this.player_1_score, this.player_2_score, player_1, player_2, ball);
      ball.onPress = (function(_this) {
        return function() {
          return _this.socket.emit("bg_press");
        };
      })(this);
      return this.socket.on("game_started", (function(_this) {
        return function() {
          return _this.startGame();
        };
      })(this));
    };

    App.prototype.startGame = function() {
      return this.socket.on("ballmove", function(x, y) {
        ball.x = x;
        return ball.y = y;
      });
    };

    App.prototype.movePaddle_1 = function(pageY) {
      this.socket.emit("paddlemove_1", pageY);
      return this.socket.on("move_player_1", function(yCoord) {
        player_1.y = yCoord;
        if (player_1.y >= 245) {
          player_1.y = 245;
        }
        if (player_1.y <= 0) {
          return player_1.y = 0;
        }
      });
    };

    App.prototype.movePaddle_2 = function(pageY) {
      this.socket.emit("paddlemove_2", pageY);
      return this.socket.on("move_player_2", function(yCoord) {
        player_2.y = yCoord;
        if (player_2.y >= 245) {
          player_2.y = 245;
        }
        if (player_2.y <= 0) {
          return player_2.y = 0;
        }
      });
    };

    App.prototype.playerOneScore = function() {
      this.player_1_score.text = parseInt(this.player_1_score.text + 1.0);
      this.socket.on("reset_game", (function(_this) {
        return function() {
          return ball.onPress = function() {
            return _this.socket.emit("bg_press");
          };
        };
      })(this));
      ball.x = 240 - 15;
      ball.y = 160 - 15;
      if (this.player_1_score.text === 3) {
        player_1_win.x = 140;
        player_1_win.y = -90;
        this.stage.addChild(player_1_win);
        Tween.get(player_1_win).to({
          y: 115
        }, 300);
        return this.resetGame();
      }
    };

    App.prototype.playerTwoScore = function() {
      this.player_2_score.text = parseInt(this.player_2_score.text + 1.0);
      this.socket.on("reset_game", (function(_this) {
        return function() {
          return ball.onPress = function() {
            return _this.socket.emit("bg_press");
          };
        };
      })(this));
      ball.x = 240 - 15;
      ball.y = 160 - 15;
      if (this.player_2_score.text === 3) {
        player_2_win.x = 140;
        player_2_win.y = -90;
        this.stage.addChild(player_2_win);
        Tween.get(player_2_win).to({
          y: 115
        }, 300);
        return this.resetGame();
      }
    };

    App.prototype.resetGame = function() {
      this.stage.removeChild(this.player_1_score, this.player_2_score);
      this.player_1_score = new Text('0', 'bold 20px Arial', '#A3FF24');
      this.player_1_score.x = 211;
      this.player_1_score.y = 20;
      this.player_2_score = new Text('0', 'bold 20px Arial', '#A3FF24');
      this.player_2_score.x = 262;
      this.player_2_score.y = 20;
      this.stage.addChild(this.player_1_score, this.player_2_score);
      player_1_win.onPress = (function(_this) {
        return function() {
          return _this.socket.emit("remove_win");
        };
      })(this);
      this.socket.on("remove", function() {
        return Tween.get(player_1_win).to({
          y: -115
        }, 300);
      });
      player_2_win.onPress = (function(_this) {
        return function() {
          return _this.socket.emit("remove_win");
        };
      })(this);
      this.socket.on("remove", function() {
        return Tween.get(player_2_win).to({
          y: -115
        }, 300);
      });
      return ball.onPress = (function(_this) {
        return function() {
          return _this.socket.emit("bg_press");
        };
      })(this);
    };

    return App;

  })();

  $(function() {
    var app;
    return app = new App;
  });

}).call(this);
