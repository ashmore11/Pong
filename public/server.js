// Generated by CoffeeScript 1.7.1
(function() {
  var app, ball, express, io, player_1, player_2, port, reset, start_game, timer, update, user_num, users, xSpeed, ySpeed;

  express = require('express');

  app = express();

  port = 3700;

  app.use(express["static"](__dirname + '/'));

  io = require('socket.io').listen(app.listen(port));

  io.set('log level', 0);

  app.get('/', function(req, res) {
    return res.sendfile(__dirname + '/index.html');
  });

  ball = {
    x: 50,
    y: 50
  };

  player_1 = {
    x: 1,
    y: 50
  };

  player_2 = {
    x: 99,
    y: 50
  };

  xSpeed = 0.5;

  ySpeed = 0.7;

  user_num = 0;

  timer = null;

  users = [];

  io.sockets.on('connection', (function(_this) {
    return function(socket) {
      socket.on('adduser', function(user) {
        user_num += 1;
        io.sockets.emit('user_num', user_num);
        return socket.set('username', user, function() {
          users[user] = user;
          return io.sockets.emit('updateusers', user);
        });
      });
      socket.on('disconnect', function() {
        user_num -= 1;
        io.sockets.emit('user_num', user_num);
        return socket.get('username', function(err, user) {
          delete users[user];
          return io.sockets.emit('user_disconnect', user);
        });
      });
      socket.on('ball_pressed', function() {
        start_game();
        return io.sockets.emit('game_started');
      });
      socket.on('remove_win', function() {
        return io.sockets.emit('remove');
      });
      socket.on('move_1', function(percent) {
        player_1.y = percent;
        return io.sockets.emit('paddle_1', percent);
      });
      return socket.on('move_2', function(percent) {
        player_2.y = percent;
        return io.sockets.emit('paddle_2', percent);
      });
    };
  })(this));

  start_game = function() {
    clearInterval(timer);
    return timer = setInterval(update, 10);
  };

  reset = function() {
    ball = {
      x: 50,
      y: 50
    };
    player_1 = {
      x: 1,
      y: 50
    };
    player_2 = {
      x: 99,
      y: 50
    };
    io.sockets.emit('reset_game');
    clearInterval(timer);
    return timer = null;
  };

  update = function() {
    ball.x = ball.x + xSpeed;
    ball.y = ball.y + ySpeed;
    io.sockets.emit('ballmove', ball.x, ball.y);
    if (ball.y <= 5) {
      ySpeed = -ySpeed;
      io.sockets.emit('wall_hit');
    }
    if (ball.y >= 95) {
      ySpeed = -ySpeed;
      io.sockets.emit('wall_hit');
    }
    if (ball.x === player_1.x + 4 && ball.y > player_1.y - 10 && ball.y < player_1.y + 10) {
      xSpeed = -xSpeed;
      io.sockets.emit('paddle_hit');
    }
    if (ball.x === player_2.x - 4 && ball.y > player_2.y - 10 && ball.y < player_2.y + 10) {
      xSpeed = -xSpeed;
      io.sockets.emit('paddle_hit');
    }
    if (ball.x > 99) {
      xSpeed = -xSpeed;
      io.sockets.emit('player_1_score');
      reset();
    }
    if (ball.x < 1) {
      xSpeed = -xSpeed;
      io.sockets.emit('player_2_score');
      return reset();
    }
  };

}).call(this);
